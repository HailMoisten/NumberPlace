<!DOCTYPE html>
<html lang="jp">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-14717K4QJ1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-14717K4QJ1');
  </script>
  <meta charset="UTF-8">
  <title>Number Place</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="favicon.ico">
  <style>
    /* ---------------------------------------------------
       Basic Layout, Fonts & Responsive Adjustments
    --------------------------------------------------- */
    body {
      font-family: 'Gill Sans', Helvetica, 'Noto Sans JP', Arial, sans-serif;
      background-color: #f7f7f7;
      margin: 0;
      padding: 0;
      text-align: center;
      position: relative;
      /* overflow: hidden; Prevent vertical scrolling */
      height: 100vh;
    }
    /* Common container styling for each screen */
    #startScreen, #gameScreen, #resultScreen {
      padding: 20px;
    }
    h1, h2 {
      margin: 10px;
      animation: fadeIn 1s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* ---------------------------------------------------
       Buttons
    --------------------------------------------------- */
    button {
      font-family: 'Gill Sans', Helvetica, 'Noto Sans JP', Arial, sans-serif;
      margin: 5px;
      padding: 8px 12px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s;
      background-color: #555;
      color: #fff;
    }
    button:hover {
      background-color: #444;
      transform: scale(1.05);
    }
    /* Fixed width for mode toggle so size remains constant */
    #modeToggleBtn {
      min-width: 150px;
    }
    
    /* ---------------------------------------------------
       Top Status Line – Displays Difficulty and Time
    --------------------------------------------------- */
    #statusLine {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      font-size: 18px;
      margin-bottom: 10px;
    }
    #difficultyDisplay { font-weight: bold; }
    
    /* ---------------------------------------------------
       np Grid – Board of 9x9 cells (default cell: 50x50px)
    --------------------------------------------------- */
    #npGrid {
      border-collapse: collapse;
      margin: 0 auto 10px;
    }
    #npGrid td {
      width: 8vmin;
      height: 8vmin;
      aspect-ratio: 1;
      max-width: 70px;
      max-height: 70px;
      aspect-ratio: 1;
      border: 1px solid #999;
      position: relative;
      vertical-align: middle;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    /* Thick borders for 3×3 blocks */
    #npGrid tr:nth-child(3n+1) td { border-top: 3px solid #333; }
    #npGrid tr td:nth-child(3n+1) { border-left: 3px solid #333; }
    #npGrid tr:last-child td { border-bottom: 3px solid #333; }
    #npGrid tr td:last-child { border-right: 3px solid #333; }
    
    /* ---------------------------------------------------
       Cell Content – Main number & Candidate Notes
         .main-valueはセル全体を埋めるように設定（iOS Chrome対策）
    --------------------------------------------------- */
    .cell-content {
      width: 100%;
      height: 100%;
      position: relative;
    }
    .main-value {
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 22px;
      font-weight: bold;
      width: 100%;
      height: 100%;
    }
    .notes {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      pointer-events: none;
      font-size: 14px;
      color: #999;
    }
    .notes .note {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    /* Given cells styling */
    td.given .main-value {
      background-color: #eaeaea;
      font-weight: bold;
    }
    /* Answered (user input) cells */
    td.answered .main-value {
      background-color: #fff;
    }
    /* Selected cell highlight */
    td.selected {
      outline: 2px solid #FF6600;
      z-index: 1;
    }
    /* Correct answer flash */
    td.correct {
      animation: correctFlash 0.5s;
    }
    @keyframes correctFlash {
      from { background-color: #b2fab4; }
      to { background-color: transparent; }
    }
    /* Wrong answer flash */
    td.wrong {
      animation: wrongFlash 0.5s;
    }
    @keyframes wrongFlash {
      from { background-color: #fbb; }
      to { background-color: transparent; }
    }
    /* ---------------------------------------------------
       Candidate Highlight Colors:
         1 candidate: green tone,
         2 candidates: yellow tone,
         3 candidates: red tone.
    --------------------------------------------------- */
    td.cand1 { background-color: #d4edda !important; }
    td.cand2 { background-color: #fff3cd !important; }
    td.cand3 { background-color: #f8d7da !important; }
    
    /* ---------------------------------------------------
       Number Buttons – Grid layout (below the np grid)
    --------------------------------------------------- */
    #numberButtons {
      display: grid;
      grid-template-columns: repeat(9, 11%);
      max-width: 486px;
      justify-content: center;
      text-align: center;
      margin-left: auto;
      margin-right: auto;
      margin-bottom: 10px;
    }
    
    /* ---------------------------------------------------
       Stats Panel – Displays: Points, correct count, mistakes, combo
    --------------------------------------------------- */
    #statsPanel {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      font-size: 18px;
      margin-bottom: 10px;
    }
    
    /* ---------------------------------------------------
       Controls Panel – Candidate Highlight, Mode Toggle, Give Up
    --------------------------------------------------- */
    #controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    
    /* ---------------------------------------------------
       Animations for Combo, Mistakes, Corrects & Points
    --------------------------------------------------- */
    .animate-combo {
      animation: comboPulse 0.5s ease;
    }
    @keyframes comboPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
    .animate-mistake {
      animation: mistakePulse 0.5s ease;
    }
    @keyframes mistakePulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
    .animate-correct {
      animation: correctPulse 0.5s ease;
    }
    @keyframes correctPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
    .animate-points {
      animation: pointsPulse 0.5s ease;
    }
    @keyframes pointsPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
    
    /* ---------------------------------------------------
       Result Overlay – Dimmed background over game screen
    --------------------------------------------------- */
    #resultScreen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 10;
      display: none;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    /* Result Card styling */
    #resultCard {      
      background: rgba(255, 255, 255, 0.8);
      padding: 20px 30px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      text-align: center;
      font-size: 18px;
      color: #333;
      animation: fadeIn 0.5s ease;
      max-width: 90%;
    }
    #resultDifficulty { 
      font-size: 22px; 
      font-weight: bold; 
      margin-right: 10px; 
    }
    #resultScore { 
      font-size: 28px; 
      font-weight: bold; 
      margin-left: 10px; 
      margin-right: 20px; 
    }
    /* Result stats in one line */
    #resultStats {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      font-size: 18px;
      margin-bottom: 10px;
    }
    /* Signature Area */
    #signatureArea {
      background: rgba(255, 255, 255, 0.3);
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
      width: 450px;
      max-width: 100%;
    }
    #signatureArea h3 {
      margin: 0 0 5px 0;
      font-size: 16px;
      text-align: left;
    }
    
    /* ---------------------------------------------------
       Responsive Design Adjustments (スマホ版: 文字・ボタン大め)
    --------------------------------------------------- */
    @media (max-width: 600px) {
      #npGrid td {
        width: 8vmin;
        height: 8vmin;
        aspect-ratio: 1;
      }
      .main-value {
        font-size: 22px;
        /* 行の高さはflexで中央揃えのため不要 */
      }
      .notes {
        font-size: 10px;
      }
      #numberButtons {
        grid-template-columns: repeat(9, 11%);
        max-width: 450px;
      }
      button, #modeToggleBtn {
        font-size: 14px;
        padding: 10px 14px;
      }
      #statusLine, #statsPanel, #resultStats {
        font-size: 20px;
      }
      #signatureArea {
        width: 95%;
      }
    }
  </style>
</head>
<body>
  <!-- Start Screen: Difficulty Selection -->
  <div id="startScreen">
    <h1>Number Place</h1>
    <p>Select Difficulty</p>
    <button id="superEasyBtn" style="background-color: #306061;">Super Easy 10 (1)</button>
    <button id="easyBtn" style="background-color: #30613b;">Easy 20 (2)</button>
    <button id="mediumBtn" style="background-color: #74663a;">Medium 30 (3)</button>
    <button id="hardBtn" style="background-color: #613030;">Hard 40 (4)</button>
    <button id="ultraHardBtn" style="background-color: #60306b;">Ultra Hard 50 (5)</button>
  </div>
  
  <!-- Game Screen -->
  <div id="gameScreen" style="display:none;">
    <!-- Top Status Line: Difficulty and Time -->
    <div id="statusLine">
      <span id="difficultyDisplay"></span>
      <span id="timeDisplay">00:00</span>
    </div>
    <!-- np Grid -->
    <table id="npGrid"></table>
    <!-- Number Buttons (1-9) -->
    <div id="numberButtons"></div>
    <!-- Stats Panel: Points, correct count, mistakes, combo -->
    <div id="statsPanel">
      <span id="pointsDisplay">1 pt</span>
      <span id="correctsDisplay">○ 0</span>
      <span id="mistakesDisplay">× 0</span>
      <span id="comboDisplay">0 combo</span>
    </div>
    <!-- Controls Panel: Candidate Highlight, Mode Toggle, Give Up -->
    <div id="controls">
      <button id="highlightBtn">Candidate Highlight (h): 0 pt</button>
      <button id="modeToggleBtn">Answer (a) / <b>Memo (m)</b></button>
      <button id="giveUpBtn">Give up(Esc) -1 pt</button>
    </div>
  </div>
  
  <!-- Result Overlay -->
  <div id="resultScreen" style="display:none;">
    <div id="resultCard">
      <span id="resultDifficulty"></span>
      <strong>Score </strong><span id="resultScore"></span>
      <button id="restartBtn">Replay (Esc)</button>
      <!-- Result Stats -->
      <div id="resultStats">
        <span id="resultTime"></span>
        <span id="resultPoints"></span>
        <span id="resultCorrects"></span>
        <span id="resultMistakes"></span>
        <span id="resultCombo"></span>
      </div>
      <!-- Signature Area -->
      <div id="signatureArea">
        <h3>Signature</h3>
        <canvas id="signatureCanvas" width="450" height="150"></canvas>
      </div>
    </div>
  </div>
  
  <script>
    /********************************************
     * Global Variables & Difficulty Settings
    ********************************************/
    let board = [];           // Current board (9x9 array)
    let solution = [];        // Complete solution board
    let givenPuzzle = [];     // Initial puzzle (given cells)
    let selectedCell = null;  // Currently selected cell (<td> element)
    let timerInterval = null; // Timer interval
    let startTime;            // Game start time
    let mistakeCount = 0;     // Number of mistakes
    let correctCount = 0;     // Count of correctly answered cells
    let comboCount = 0;       // Combo count for consecutive correct answers
    let currentDifficulty = 'easy';
    let candidateHighlightLevel = 0;  // 0 ~ 3
    let isNoteMode = false;   // false: Answer mode, true: Memo mode
    let points = 1;           // Starting points
    let difficultyColor = "#000"; // 選択ボタンの背景色から設定
    let diffText = "";
    
    const difficultySettings = {
      superEasy: { cells: 10, label: "Super Easy 10" },
      easy: { cells: 20, label: "Easy 20" },
      medium: { cells: 30, label: "Medium 30" },
      hard: { cells: 40, label: "Hard 40" },
      ultraHard: { cells: 50, label: "Ultra Hard 50" }
    };
    
    /********************************************
     * Utility: Deep Copy an Array
    ********************************************/
    function deepCopy(arr) {
      return arr.map(row => row.slice());
    }
    
    /********************************************
     * Generate a complete board (backtracking)
    ********************************************/
    function generateCompleteBoard() {
      let board = Array.from({ length: 9 }, () => Array(9).fill(0));
      function isValid(board, r, c, num) {
        for (let i = 0; i < 9; i++) {
          if (board[r][i] === num || board[i][c] === num) return false;
        }
        const boxRow = Math.floor(r / 3) * 3;
        const boxCol = Math.floor(c / 3) * 3;
        for (let i = 0; i < 3; i++) {
          for (let j = 0; j < 3; j++) {
            if (board[boxRow + i][boxCol + j] === num) return false;
          }
        }
        return true;
      }
      function shuffle(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      }
      function solve(cell = 0) {
        if (cell === 81) return true;
        const r = Math.floor(cell / 9);
        const c = cell % 9;
        if (board[r][c] !== 0) return solve(cell + 1);
        let nums = shuffle([1,2,3,4,5,6,7,8,9]);
        for (let num of nums) {
          if (isValid(board, r, c, num)) {
            board[r][c] = num;
            if (solve(cell + 1)) return true;
            board[r][c] = 0;
          }
        }
        return false;
      }
      solve();
      return board;
    }
    
    /********************************************
     * Create Puzzle: Remove cells based on difficulty
    ********************************************/
    function createPuzzle(fullBoard, difficulty) {
      let puzzle = deepCopy(fullBoard);
      let cellsToRemove = difficultySettings[difficulty].cells;
      while (cellsToRemove > 0) {
        const r = Math.floor(Math.random() * 9);
        const c = Math.floor(Math.random() * 9);
        if (puzzle[r][c] !== 0) {
          puzzle[r][c] = 0;
          cellsToRemove--;
        }
      }
      return puzzle;
    }
    
    /********************************************
     * Render the np Grid.
    ********************************************/
    function renderGrid() {
      const grid = document.getElementById('npGrid');
      grid.innerHTML = '';
      for (let r = 0; r < 9; r++) {
        const rowElem = document.createElement('tr');
        for (let c = 0; c < 9; c++) {
          const cell = document.createElement('td');
          cell.dataset.row = r;
          cell.dataset.col = c;
          // Initialize memo note set for this cell
          cell.noteSet = new Set();
          const cellContent = document.createElement('div');
          cellContent.classList.add('cell-content');
          const mainValue = document.createElement('div');
          mainValue.classList.add('main-value');
          if (givenPuzzle[r][c] !== 0) {
            mainValue.textContent = givenPuzzle[r][c];
          }
          const notesDiv = document.createElement('div');
          notesDiv.classList.add('notes');
          cellContent.appendChild(mainValue);
          cellContent.appendChild(notesDiv);
          cell.appendChild(cellContent);
          if (givenPuzzle[r][c] !== 0) {
            cell.classList.add('given');
          }
          cell.addEventListener('click', onCellClick);
          rowElem.appendChild(cell);
        }
        grid.appendChild(rowElem);
      }
      // 自動で中央付近のセルを選択（4,4：0-indexed）
      let initCell = document.querySelector('#npGrid td[data-row="4"][data-col="4"]');
      if (initCell) {
        selectedCell = initCell;
        selectedCell.classList.add('selected');
      }
    }
    
    /********************************************
     * Render Number Buttons (1-9)
    ********************************************/
    function renderNumberButtons() {
      const container = document.getElementById('numberButtons');
      container.innerHTML = '';
      for (let i = 1; i <= 9; i++) {
        const btn = document.createElement('button');
        btn.style.margin = '2px';
        btn.style.paddingLeft = '0px';
        btn.style.paddingRight = '0px';
        btn.style.paddingTop = '12px';
        btn.style.paddingBottom = '12px';
        btn.style.fontWeight = 'Bold';
        btn.textContent = i;
        btn.dataset.number = i;
        btn.addEventListener('click', () => onNumberInput(parseInt(btn.dataset.number)));
        container.appendChild(btn);
      }
    }
    
    /********************************************
     * Cell Click Handler
    ********************************************/
    function onCellClick(e) {
      if (selectedCell) {
        selectedCell.classList.remove('selected');
      }
      selectedCell = e.currentTarget;
      selectedCell.classList.add('selected');
    }
    
    /********************************************
     * Number Input Handler
    ********************************************/
    function onNumberInput(num) {
      if (!selectedCell) return;
      const r = parseInt(selectedCell.dataset.row);
      const c = parseInt(selectedCell.dataset.col);
      if (board[r][c] !== 0) return;
      const mainValueElem = selectedCell.querySelector('.main-value');
      const notesElem = selectedCell.querySelector('.notes');
      
      if (isNoteMode) {
        // Memo mode: 初回は1～9をセット
        if (selectedCell.noteSet.size === 0) {
          for (let i = 1; i <= 9; i++) {
            selectedCell.noteSet.add(i);
          }
        }
        // 数字のトグル
        if (selectedCell.noteSet.has(num)) {
          selectedCell.noteSet.delete(num);
        } else {
          selectedCell.noteSet.add(num);
        }
        updateCellNotes(selectedCell);
      } else {
        // Answer mode: 回答チェック
        if (solution[r][c] === num) {
          let bonus = getCandidates(r, c).length;
          board[r][c] = num;
          mainValueElem.textContent = num;
          selectedCell.classList.add('correct', 'answered');
          comboCount++;
          points += bonus * comboCount;
          showPointBonus(bonus * comboCount);
          correctCount++;
          const comboDisplay = document.getElementById('comboDisplay');
          comboDisplay.classList.add('animate-combo');
          setTimeout(() => comboDisplay.classList.remove('animate-combo'), 500);
          clearCandidateHighlights();
          candidateHighlightLevel = 0;
          document.getElementById('highlightBtn').textContent = 'Candidate Highlight (h): 0 pt';
          selectedCell.noteSet.clear();
          notesElem.innerHTML = '';
          updateStats();
          if (isBoardComplete()) {
            clearInterval(timerInterval);
            showResult();
          }
        } else {
          mistakeCount++;
          comboCount = 0;
          const mistakesDisplay = document.getElementById('mistakesDisplay');
          mistakesDisplay.classList.add('animate-mistake');
          setTimeout(() => mistakesDisplay.classList.remove('animate-mistake'), 500);
          updateStats();
          selectedCell.classList.add('wrong');
          const candidates = getCandidates(r, c);
          updateCellNotesWithCandidates(selectedCell, candidates);
          setTimeout(() => selectedCell.classList.remove('wrong'), 500);
        }
      }
    }
    
    /********************************************
     * Update a cell's memo notes (Memo mode)
    ********************************************/
    function updateCellNotes(cell) {
      const notesElem = cell.querySelector('.notes');
      notesElem.innerHTML = '';
      const notesArray = Array.from(cell.noteSet).sort((a, b) => a - b);
      notesArray.forEach(n => {
        const noteDiv = document.createElement('div');
        noteDiv.classList.add('note');
        noteDiv.style.gridColumnStart = ((n - 1) % 3) + 1;
        noteDiv.style.gridRowStart = Math.floor((n - 1) / 3) + 1;
        noteDiv.textContent = n;
        notesElem.appendChild(noteDiv);
      });
    }
    
    /********************************************
     * Update cell notes with candidate numbers (on wrong answer)
    ********************************************/
    function updateCellNotesWithCandidates(cell, candidates) {
      const notesElem = cell.querySelector('.notes');
      notesElem.innerHTML = '';
      candidates.forEach(n => {
        const noteDiv = document.createElement('div');
        noteDiv.classList.add('note');
        noteDiv.style.gridColumnStart = ((n - 1) % 3) + 1;
        noteDiv.style.gridRowStart = Math.floor((n - 1) / 3) + 1;
        noteDiv.textContent = n;
        notesElem.appendChild(noteDiv);
      });
    }
    
    /********************************************
     * Clear candidate highlights on all cells
    ********************************************/
    function clearCandidateHighlights() {
      document.querySelectorAll('#npGrid td').forEach(cell => {
        cell.classList.remove('cand1','cand2','cand3');
      });
    }
    
    /********************************************
     * Update candidate highlights based on valid candidate count
    ********************************************/
    function updateCandidateHighlights() {
      document.querySelectorAll('#npGrid td').forEach(cell => {
        const r = parseInt(cell.dataset.row);
        const c = parseInt(cell.dataset.col);
        if (board[r][c] !== 0) {
          cell.classList.remove('cand1','cand2','cand3');
          return;
        }
        const candidates = getCandidates(r, c);
        cell.classList.remove('cand1','cand2','cand3');
        if (candidates.length > 0 && candidates.length <= candidateHighlightLevel) {
          cell.classList.add('cand' + candidates.length);
        }
      });
      document.getElementById('highlightBtn').textContent = 'Candidate Highlight (h): ' + candidateHighlightLevel + ' pt';
    }
    
    /********************************************
     * Check if placing num at board[r][c] is valid.
    ********************************************/
    function isValidForCell(board, r, c, num) {
      for (let i = 0; i < 9; i++) {
        if (board[r][i] === num || board[i][c] === num) return false;
      }
      const boxRow = Math.floor(r / 3) * 3;
      const boxCol = Math.floor(c / 3) * 3;
      for (let i = 0; i < 3; i++) {
        for (let j = 0; j < 3; j++) {
          if (board[boxRow + i][boxCol + j] === num) return false;
        }
      }
      return true;
    }
    
    /********************************************
     * Get valid candidate numbers for cell [r][c]
    ********************************************/
    function getCandidates(r, c) {
      let candidates = [];
      if (board[r][c] !== 0) return candidates;
      for (let num = 1; num <= 9; num++) {
        if (isValidForCell(board, r, c, num)) {
          candidates.push(num);
        }
      }
      return candidates;
    }
    
    /********************************************
     * Update Timer display (mm:ss)
    ********************************************/
    function updateTimer() {
      const now = new Date();
      const elapsed = Math.floor((now - startTime) / 1000);
      const m = String(Math.floor(elapsed / 60)).padStart(2, '0');
      const s = String(elapsed % 60).padStart(2, '0');
      document.getElementById('timeDisplay').textContent = m + ':' + s;
    }
    
    /********************************************
     * Start Timer
    ********************************************/
    function startTimer() {
      startTime = new Date();
      timerInterval = setInterval(updateTimer, 1000);
    }
    
    /********************************************
     * Check if the board is completely filled
    ********************************************/
    function isBoardComplete() {
      for (let r = 0; r < 9; r++) {
        for (let c = 0; c < 9; c++) {
          if (board[r][c] === 0) return false;
        }
      }
      return true;
    }
    
    /********************************************
     * Update Stats Panel (Points, correct count, mistakes, combo)
    ********************************************/
    function updateStats() {
      document.getElementById('pointsDisplay').textContent = points + " pt";
      document.getElementById('mistakesDisplay').textContent = "× " + mistakeCount;
      document.getElementById('correctsDisplay').textContent = "○ " + correctCount;
      document.getElementById('comboDisplay').textContent = comboCount + " combo";
    }
    
    /********************************************
     * Show bonus point animation above points display.
    ********************************************/
    function showPointBonus(bonus) {
      if (bonus <= 0) return;
      const bonusElem = document.createElement('span');
      bonusElem.textContent = " + " + bonus + " pt";
      bonusElem.style.color = "#28a745";
      bonusElem.style.fontSize = "18px";
      bonusElem.style.fontWeight = "bold";
      bonusElem.style.position = "absolute";
      const pointsDisplay = document.getElementById('pointsDisplay');
      const rect = pointsDisplay.getBoundingClientRect();
      bonusElem.style.left = (rect.left + rect.width/2) + "px";
      bonusElem.style.top = rect.top + 4 + "px";
      bonusElem.style.transform = "translate(-50%, -110%)";
      document.body.appendChild(bonusElem);
      bonusElem.style.transition = "opacity 1.5s ease, transform 1.5s ease";
      setTimeout(() => {
        bonusElem.style.opacity = "0";
        bonusElem.style.transform = "translate(-50%, -150%)";
      }, 100);
      setTimeout(() => { document.body.removeChild(bonusElem); }, 1600);
      updateStats();
    }
    
    /********************************************
     * Initialize Game: Setup board, reset counts, render grid & buttons.
    ********************************************/
    function initGame(difficulty) {
      currentDifficulty = difficulty;
      solution = generateCompleteBoard();
      givenPuzzle = createPuzzle(solution, difficulty);
      board = deepCopy(givenPuzzle);
      mistakeCount = 0;
      correctCount = 0;
      comboCount = 0;
      candidateHighlightLevel = 0;
      points = 1;
      updateStats();
      diffText = difficultySettings[difficulty].label;
      document.getElementById('difficultyDisplay').innerHTML = "<span style='color:" + difficultyColor + "'>" + diffText + "</span>";
      renderGrid();
      renderNumberButtons();
      clearCandidateHighlights();
      startTimer();
    }
    
    /********************************************
     * Show Result Overlay
    ********************************************/
    function showResult() {
      clearInterval(timerInterval);
      document.getElementById('resultDifficulty').innerHTML = "<span style='color:" + difficultyColor + "'>" + diffText + "</span>";
      const elapsed = Math.floor((new Date() - startTime) / 1000);
      const m = String(Math.floor(elapsed / 60)).padStart(2, '0');
      const s = String(elapsed % 60).padStart(2, '0');
      const score = Math.round(points * 60/(Math.floor(elapsed / 60)*60 + (Math.floor(elapsed % 60))||1) * (1 - (mistakeCount/(correctCount||1))));
      document.getElementById('resultScore').innerHTML = "<span>" + score + "</span>";
      const resultStats = document.getElementById('resultStats');
      resultStats.innerHTML = 
        "<span>" + m + ":" + s + "</span>" +
        "<span>" + points + " pt</span>" +
        "<span>○ " + correctCount + "</span>" +
        "<span>× " + mistakeCount + "</span>" +
        "<span>" + comboCount + " combo</span>";
      document.getElementById('resultScreen').style.display = "flex";
    }
    
    /********************************************
     * "Give up" Button – Show result immediately.
    ********************************************/
    document.getElementById('giveUpBtn').addEventListener('click', function(){
      clearInterval(timerInterval);
      points--;
      showResult();
    });
    
    /********************************************
     * "Replay" Button – Return to Start Screen.
    ********************************************/
    document.getElementById('restartBtn').addEventListener('click', function(){
      document.getElementById('resultScreen').style.display = "none";
      document.getElementById('gameScreen').style.display = "none";
      document.getElementById('startScreen').style.display = "block";
      document.getElementById('npGrid').innerHTML = "";
    });
    
    /********************************************
     * Keyboard Input Handling
    ********************************************/
    document.addEventListener('keydown', (e) => {
      if (document.getElementById('startScreen').style.display !== "none") {
        if (e.key === "1") { document.getElementById('superEasyBtn').click(); return; }
        if (e.key === "2") { document.getElementById('easyBtn').click(); return; }
        if (e.key === "3") { document.getElementById('mediumBtn').click(); return; }
        if (e.key === "4") { document.getElementById('hardBtn').click(); return; }
        if (e.key === "5") { document.getElementById('ultraHardBtn').click(); return; }
      }
      if (document.getElementById('resultScreen').style.display !== "none") {
        if (e.key === "Escape") { document.getElementById('restartBtn').click(); return; }
      }
      if (document.getElementById('gameScreen').style.display !== "none") {
        if (e.key.toLowerCase() === "h") { 
          document.getElementById('highlightBtn').click(); 
          return; 
        }
        if (isNoteMode && e.key.toLowerCase() === "a") { 
          isNoteMode = false; 
          updateModeButton(); 
          return; 
        }
        if (!isNoteMode && e.key.toLowerCase() === "m") { 
          isNoteMode = true; 
          updateModeButton(); 
          return; 
        }
        if (e.key === "Escape") { 
          document.getElementById('giveUpBtn').click(); 
          return; 
        }
        if (!selectedCell) return;
        const r = parseInt(selectedCell.dataset.row);
        const c = parseInt(selectedCell.dataset.col);
        let newR = r, newC = c;
        switch(e.key) {
          case "ArrowUp": newR = (r > 0) ? r - 1 : r; break;
          case "ArrowDown": newR = (r < 8) ? r + 1 : r; break;
          case "ArrowLeft": newC = (c > 0) ? c - 1 : c; break;
          case "ArrowRight": newC = (c < 8) ? c + 1 : c; break;
          default:
            if (/^[1-9]$/.test(e.key)) {
              onNumberInput(parseInt(e.key));
            }
            return;
        }
        const newCell = document.querySelector(`#npGrid td[data-row="${newR}"][data-col="${newC}"]`);
        if (newCell) {
          if (selectedCell) selectedCell.classList.remove('selected');
          selectedCell = newCell;
          selectedCell.classList.add('selected');
        }
      }
    });
    
    /********************************************
     * Candidate Highlight Button
    ********************************************/
    document.getElementById('highlightBtn').addEventListener('click', () => {
      if (candidateHighlightLevel < 3 && points > 0) {
        points--;
        candidateHighlightLevel++;
        updateCandidateHighlights();
        updateStats();
      }
    });
    
    /********************************************
     * Mode Toggle Button
    ********************************************/
    function updateModeButton() {
      const btn = document.getElementById('modeToggleBtn');
      if (isNoteMode) {
        btn.innerHTML = "Answer (a) / <b>Memo (m)</b>";
      } else {
        btn.innerHTML = "<b>Answer (a)</b> / Memo (m)";
      }
    }
    document.getElementById('modeToggleBtn').addEventListener('click', function(){
      isNoteMode = !isNoteMode;
      updateModeButton();
    });
    updateModeButton();
    
    /********************************************
     * Start Screen Difficulty Buttons (Refactored)
    ********************************************/
    const difficultyButtons = [
      { id: 'superEasyBtn', difficulty: 'superEasy' },
      { id: 'easyBtn', difficulty: 'easy' },
      { id: 'mediumBtn', difficulty: 'medium' },
      { id: 'hardBtn', difficulty: 'hard' },
      { id: 'ultraHardBtn', difficulty: 'ultraHard' }
    ];
    difficultyButtons.forEach(btn => {
      document.getElementById(btn.id).addEventListener('click', function(){
        difficultyColor = this.style.backgroundColor;
        document.getElementById('startScreen').style.display = "none";
        document.getElementById('gameScreen').style.display = "block";
        initGame(btn.difficulty);
      });
    });
    
    /********************************************
     * Signature Canvas Setup (for Result Screen)
    ********************************************/
    const signatureCanvas = document.getElementById('signatureCanvas');
    const sigCtx = signatureCanvas.getContext('2d');
    let drawing = false;
    let lastX = 0, lastY = 0;
    
    function drawLine(x, y, isDown) {
      if (!isDown) return;
      sigCtx.beginPath();
      sigCtx.strokeStyle = "#000";
      sigCtx.lineWidth = 1;
      sigCtx.lineCap = "round";
      sigCtx.moveTo(lastX, lastY);
      sigCtx.lineTo(x, y);
      sigCtx.stroke();
      sigCtx.closePath();
      lastX = x;
      lastY = y;
    }
    
    signatureCanvas.addEventListener('mousedown', (e) => {
      drawing = true;
      const rect = signatureCanvas.getBoundingClientRect();
      lastX = e.clientX - rect.left;
      lastY = e.clientY - rect.top;
    });
    signatureCanvas.addEventListener('mousemove', (e) => {
      if (!drawing) return;
      const rect = signatureCanvas.getBoundingClientRect();
      drawLine(e.clientX - rect.left, e.clientY - rect.top, true);
    });
    signatureCanvas.addEventListener('mouseup', () => drawing = false);
    signatureCanvas.addEventListener('mouseout', () => drawing = false);
    // Touch events for mobile
    signatureCanvas.addEventListener('touchstart', (e) => {
      e.preventDefault();
      drawing = true;
      const rect = signatureCanvas.getBoundingClientRect();
      const touch = e.touches[0];
      lastX = touch.clientX - rect.left;
      lastY = touch.clientY - rect.top;
    });
    signatureCanvas.addEventListener('touchmove', (e) => {
      e.preventDefault();
      if (!drawing) return;
      const rect = signatureCanvas.getBoundingClientRect();
      const touch = e.touches[0];
      drawLine(touch.clientX - rect.left, touch.clientY - rect.top, true);
    });
    signatureCanvas.addEventListener('touchend', () => drawing = false);
  </script>
</body>
</html>
